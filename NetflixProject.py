# -*- coding: utf-8 -*-
"""NetflixProject.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/14MGuCiDW1yv8z6yc4xuvm_kTQ1gp_BBZ
"""

from bs4 import BeautifulSoup
import requests
import pandas as pd
import json

!pip install omdb 
import omdb
omdb.set_default('apikey', '1dd41fb6')

user_agent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36'
HEADERS = {'User-Agent':user_agent , 'Accept-Language': 'en-US, en;q=0.5'}

from google.colab import drive
drive.mount('/content/drive')
import pandas as pd
# IMDB_rating_df = pd.read_excel('/content/IMDB_rating_df.xlsx')
# NetflixData = pd.read_excel('/content/NetflixData.xlsx')
# df = pd.read_excel('/content/df.xlsx')
# netflix_movies_df = pd.read_excel('/content/netflix_movies_df.xlsx')
# netflix_tvshow_df = pd.read_excel('/content/netflix_tvshow_df.xlsx')

def get_data(url):
    response = requests.get(url, headers=HEADERS)
    if response.status_code == 200:
        soup = BeautifulSoup(response.content, "html.parser")
        links = soup.find_all("a", attrs={'class':'nm-collections-title nm-collections-link'}) 
        data = []
        for link in links:
            href = link.get('href')
            response = requests.get(href, headers=HEADERS)
            if response.status_code == 200:
                soup2 = BeautifulSoup(response.content, "html.parser")
                parsed_data = json.loads(soup2.find("script").text)

                temp = {
                    'name': parsed_data.get("name"),
                    'date': parsed_data.get("dateCreated"),
                    'type': parsed_data.get("@type"),
                    'url': parsed_data.get("url"),
                    'rating': parsed_data.get("contentRating"),
                    'genres': [genre.text for genre in (soup2.find_all("a", attrs={"class":"more-details-item item-genres"}))],
                    'description': parsed_data.get("description")
                }
                data.append(temp)
        df = pd.DataFrame(data)
        duplicateRows = df[df.duplicated(['name'])]
        df = df.drop(duplicateRows.index.values.tolist())
        df = df.reset_index(drop=True)
        return df
    return None

# Movies
URL = "https://www.netflix.com/browse/genre/34399?so=su&order=popularity"
netflix_movies_df = get_data(URL)
netflix_movies_df

duplicateRows_movie = netflix_movies_df[netflix_movies_df.duplicated(['name'])]
netflix_movies_df = netflix_movies_df.drop(duplicateRows_movie.index.values.tolist())
netflix_movies_df = netflix_movies_df.reset_index(drop=True)
netflix_movies_df.to_excel("netflix_movies_df.xlsx", index = False)
netflix_movies_df

# Series
# URL = "https://www.netflix.com/browse/genre/83"
URL = "https://www.netflix.com/browse/genre/83?so=su&order=popularity"
netflix_tvshow_df = get_data(URL)

netflix_tvshow_df

duplicateRows_tvshow = netflix_tvshow_df[netflix_tvshow_df.duplicated(['name'])]
netflix_tvshow_df = netflix_tvshow_df.drop(duplicateRows_tvshow.index.values.tolist())
netflix_tvshow_df = netflix_tvshow_df.reset_index(drop=True)
netflix_tvshow_df.to_excel("netflix_tvshow_df.xlsx", index = False)
netflix_tvshow_df

dataset = pd.concat([netflix_movies_df, netflix_tvshow_df], axis=0) 
dataset = dataset.reset_index(drop=True)
dataset

data = []
for name in dataset['name']:
  movie = omdb.title(name)
  if movie:
    temp = {
              'name': name,
              'language':movie['language'], 
              'country':movie['country'],
              'awards':movie['awards'],
              'imdb_rating':movie['imdb_rating'],    
              'imdb_votes':movie['imdb_votes'], 
              'imdb_id':movie['imdb_id']                             
    }
    data.append(temp)
IMDB_rating_df = pd.DataFrame(data)
IMDB_rating_df

IMDB_rating_df.to_excel("IMDB_rating_df.xlsx", index=False)
IMDB_rating_df

IMDB_rating_df = IMDB_rating_df.rename(columns={'name': 'drop_name'})
df = pd.concat([dataset, IMDB_rating_df], axis =1,join='inner')
df = df.drop('drop_name', axis=1)
df

import re
def text_preprocessing(df,column_name):
  df[column_name] = df[column_name].astype(str)
  for idx in range(len(df[column_name])):
    df[column_name][idx] = re.sub(r'[\[\]\tt\'"]+', '', df[column_name][idx] )
  return df

text_preprocessing(df,'genres')
text_preprocessing(df,'imdb_id')

df.to_excel("netflix_ratings.xlsx", index=False)